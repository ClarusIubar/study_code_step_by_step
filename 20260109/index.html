<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        .container { display: flex; gap: 20px; padding: 20px; font-family: sans-serif; }
        .box { border: 2px solid #333; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .grid-6x6 { flex: 1.5; display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; border: 2px solid #333; padding: 10px; }
        .grid-item { border: 1px solid #ddd; padding: 10px 2px; text-align: center; font-size: 11px; color: #888; }
        .side-panel { flex: 1; display: flex; flex-direction: column; }
        
        /* 결제 시스템 영역 (추후 추가를 위해 비워둠) */
        .payment-placeholder { height: 100px; margin-bottom: 15px; border: 1px dashed #bbb; display: flex; align-items: center; justify-content: center; color: #999; }

        .input-group { display: flex; gap: 10px; margin-top: 5px; }
        #code-input { width: 80px; padding: 10px; font-size: 1.2rem; border: 2px solid #007bff; border-radius: 4px; }
        #confirm-btn { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; }
        
        .output-slot { height: 100px; background: #333; border: 5px inset #222; display: flex; align-items: center; justify-content: center; color: #FFD700; font-weight: bold; font-size: 1.5rem; }
        #display-log { background: #222; color: #0f0; padding: 15px; margin-top: 10px; border-radius: 5px; font-family: monospace; }
    </style>
    <py-config>
        [[fetch]]
        files = ["logic.py"]
    </py-config>
</head>
<body>

<div class="container">
    <div id="product-grid" class="grid-6x6"></div>

    <div class="side-panel">
        <div class="box">
            <h3>건의함</h3>
            <input type="text" id="wish-input" placeholder="추가 요청">
            <button id="wish-btn">등록</button>
        </div>

        <div class="box">
            <h3>제품 번호 입력 (1~36)</h3>
            <div class="input-group">
                <input type="text" id="code-input" placeholder="00">
                <button id="confirm-btn">결정</button>
            </div>
        </div>

        <div class="payment-placeholder">결제 시스템 모듈 대기 중</div>

        <div class="box">
            <h3>상품 토출구 (Output)</h3>
            <div id="product-out" class="output-slot">EMPTY</div>
        </div>
    </div>
</div>

<div id="display-log">> 시스템 로딩 중...</div>

<script type="py">
    from logic import VendingMachine
    from pyscript import document
    from pyodide.ffi import create_proxy

    vm = VendingMachine()

    # 좌측 그리드 시각화
    grid_div = document.querySelector("#product-grid")
    for i in range(1, 37):
        div = document.createElement("div")
        div.className = "grid-item"
        div.innerText = f"{i}\n상품-{i:02d}"
        grid_div.appendChild(div)

    # 결정 버튼 클릭 처리 함수
    def handle_confirm(event):
        input_el = document.querySelector("#code-input")
        val = input_el.value
        
        # Process
        item, status = vm.get_product(val)
        
        # Output
        document.querySelector("#display-log").innerText = f"> {status}"
        slot = document.querySelector("#product-out")
        
        if item:
            slot.innerText = item
            input_el.value = ""
        else:
            slot.innerText = "EMPTY"

    def handle_wish(event):
        wish_el = document.querySelector("#wish-input")
        if wish_el.value.strip():
            document.querySelector("#display-log").innerText = f"> 건의 접수: {wish_el.value}"
            wish_el.value = ""

    # [핵심] 버튼에 이벤트 리스너 직접 연결 (undefined 'call' 에러 원천 차단)
    confirm_btn = document.querySelector("#confirm-btn")
    confirm_btn.addEventListener("click", create_proxy(handle_confirm))

    wish_btn = document.querySelector("#wish-btn")
    wish_btn.addEventListener("click", create_proxy(handle_wish))

    document.querySelector("#display-log").innerText = "> 준비 완료. 번호를 입력하세요."
</script>
</body>
</html>